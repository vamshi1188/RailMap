<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ola Maps Train Marker</title>

    <script src="https://www.unpkg.com/olamaps-web-sdk@latest/dist/olamaps-web-sdk.umd.js"></script>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map {
            width: 100vw;
            height: 90vh;
        }
        #controls {
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input { padding: 8px; width: 140px; border: 1px solid #ccc; border-radius: 4px; }
        button { 
            padding: 8px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }

        .train-icon {
            width: 40px;
            height: 40px;
            background-image: url('https://img.icons8.com/emoji/48/train-emoji.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }
    </style>
</head>

<body>

    <div id="controls">
        <input id="lat" type="number" step="0.00001" placeholder="Latitude" value="19.0760">
        <input id="lng" type="number" step="0.00001" placeholder="Longitude" value="72.8777">
        <button onclick="placeTrain()">Place Train</button>
    </div>

    <div id="map"></div>

    <script>
        let API_KEY = "";
        let map;
        let olaMaps;
        let trainMarker = null;

        // ðŸ”¥ FIRST: Fetch secure API key from backend
        async function loadAPIKey() {
            try {
                const res = await fetch("/key");
                const data = await res.json();
                API_KEY = data.api_key;

                initMap();  // load map AFTER key arrives
            } catch (err) {
                alert("Failed to load API key from backend");
                console.error(err);
            }
        }

        // ðŸ”¥ Initialize map only after we have the key
        function initMap() {
            olaMaps = new OlaMaps({ apiKey: API_KEY });

            const styleURL =
                `https://api.olamaps.io/tiles/vector/v1/styles/default-light-standard/style.json?api_key=${API_KEY}`;

            map = olaMaps.init({
                style: styleURL,
                container: "map",
                center: [72.8777, 19.0760],
                zoom: 11
            });
        }

        function placeTrain() {
            const lat = parseFloat(document.getElementById("lat").value);
            const lng = parseFloat(document.getElementById("lng").value);

            if (isNaN(lat) || isNaN(lng)) {
                alert("Enter valid lat/lng");
                return;
            }

            const coord = [lng, lat];

            map.setCenter(coord);
            map.setZoom(15);

            if (trainMarker) trainMarker.remove();

            const customMarker = document.createElement("div");
            customMarker.classList.add("train-icon");

            trainMarker = olaMaps
                .addMarker({
                    element: customMarker,
                    anchor: "center",
                    offset: [0, 0]
                })
                .setLngLat(coord)
                .addTo(map);
        }

        // ðŸ”¥ Start the process
        loadAPIKey();
    </script>

</body>
</html>
